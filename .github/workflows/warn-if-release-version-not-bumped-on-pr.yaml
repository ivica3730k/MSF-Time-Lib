name: Warn if library version not bumped

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  check-if-version-needs-bumping:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Detect whether important files changed
      # ------------------------------------------------------------
      - name: Detect source changes
        id: changes
        run: |
          git fetch origin main

          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          IMPORTANT_CHANGED=false
          KEYWORDS_CHANGED=false

          for file in $CHANGED_FILES; do
            case "$file" in
              *.c|*.cpp|*.h|*.hpp|*.ino|src/*)
                IMPORTANT_CHANGED=true
                ;;
              keywords.txt)
                KEYWORDS_CHANGED=true
                ;;
            esac
          done

          echo "important=$IMPORTANT_CHANGED" >> $GITHUB_OUTPUT
          echo "keywords=$KEYWORDS_CHANGED" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Read versions
      # ------------------------------------------------------------
      - name: Read version from PR
        id: pr_version
        run: |
          PR_VERSION=$(grep '^version=' library.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT

      - name: Read version from main
        id: main_version
        run: |
          git show origin/main:library.properties > main_library.properties
          MAIN_VERSION=$(grep '^version=' main_library.properties | cut -d'=' -f2 | tr -d ' ')
          echo "version=$MAIN_VERSION" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Add or update sticky warning
      # ------------------------------------------------------------
      - name: Add sticky warning comment
        if: steps.changes.outputs.important == 'true' && steps.pr_version.outputs.version == steps.main_version.outputs.version
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: version-check
          message: |
            ‚ö†Ô∏è **Library version must be bumped**

            This PR modifies source files (`.c`, `.cpp`, `.h`, `.ino`, or files inside `src/`),
            but the version in `library.properties` was not changed.

            Arduino Library Manager only publishes new releases when the version changes.

            Please bump:

            ```
            version=x.y.z
            ```

            to a new version before merging.

            ---

            üí° **Reminder:**
            If this PR introduces new public classes, structs, or functions,
            please also update `keywords.txt` so Arduino IDE syntax highlighting
            stays correct.

            _(This message will automatically disappear once the version is updated.)_

      # ------------------------------------------------------------
      # Remove sticky warning when no longer needed
      # ------------------------------------------------------------
      - name: Remove sticky warning
        if: steps.changes.outputs.important != 'true' || steps.pr_version.outputs.version != steps.main_version.outputs.version
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: version-check
          delete: true
